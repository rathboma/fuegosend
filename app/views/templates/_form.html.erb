<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>

<%= form_with(model: template, local: true) do |f| %>
  <% if template.errors.any? %>
    <div class="alert alert-danger small mb-4" role="alert">
      <strong><%= pluralize(template.errors.count, "error") %> prohibited this template from being saved:</strong>
      <ul class="mb-0 mt-2">
        <% template.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- Template Details (above editor) -->
  <div class="card border mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <%= f.label :name, "Template Name *", class: "form-label" %>
          <%= f.text_field :name, class: "form-control", placeholder: "e.g. Newsletter Template", required: true %>
        </div>
        <div class="col-md-6">
          <label class="form-label">&nbsp;</label>
          <div class="form-check form-switch">
            <%= f.check_box :is_default, class: "form-check-input", role: "switch" %>
            <%= f.label :is_default, "Set as default template", class: "form-check-label" %>
          </div>
        </div>
        <div class="col-12">
          <%= f.label :description, class: "form-label" %>
          <%= f.text_area :description, class: "form-control", rows: 2, placeholder: "Optional description of this template" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Editor and Preview (two-column layout) -->
  <div class="row g-4"
       data-controller="template-editor"
       data-template-editor-preview-url-value="<%= preview_template_path(template) %>"
       data-template-editor-save-url-value="<%= template.persisted? ? template_path(template) : '' %>"
       data-template-editor-upload-url-value="<%= images_path %>"
       data-template-editor-csrf-token-value="<%= form_authenticity_token %>">

    <!-- HTML Editor (Left) -->
    <div class="col-md-6">
      <div class="mb-2 d-flex justify-content-between align-items-center">
        <div>
          <strong>HTML Content</strong>
          <small class="text-muted ms-2">Full email template with Mustache tags</small>
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary" data-action="click->template-editor#openImageModal">
          ðŸ“· Insert Image
        </button>
      </div>
      <div class="card border">
        <div class="card-body p-0">
          <%= f.text_area :html_content, class: "d-none", data: { template_editor_target: "hiddenField" } %>
          <textarea data-template-editor-target="textarea" style="display: none;"><%= template.html_content %></textarea>
        </div>
      </div>
      <div class="mt-2">
        <small class="text-muted">
          <strong>Merge Tags:</strong>
          <code>{{{content}}}</code>,
          <code>{{email}}</code>,
          <code>{{name}}</code>,
          <code>{{custom_first_name}}</code>,
          <code>{{logo_url}}</code>,
          <code>{{unsubscribe_url}}</code>,
          <code>{{current_year}}</code>
        </small>
      </div>
    </div>

    <!-- Preview (Right) -->
    <div class="col-md-6">
      <div class="mb-2">
        <strong>Preview</strong>
        <small class="text-muted ms-2">How the template looks with sample content</small>
      </div>
      <div class="card border">
        <div class="card-body p-0">
          <iframe
            data-template-editor-target="preview"
            style="width: 100%; height: 600px; border: none; display: block;"
            sandbox="allow-same-origin"
            title="Template Preview">
          </iframe>
        </div>
      </div>
      <div class="mt-2">
        <small class="text-muted">
          Preview updates automatically as you type
          <span class="text-success d-none" data-template-editor-target="saveStatus">âœ“ Saved</span>
        </small>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="d-flex gap-2 mt-4">
    <%= f.submit template.new_record? ? "Create Template" : "Update Template", class: "btn btn-primary" %>
    <%= link_to "Cancel", template.new_record? ? templates_path : template, class: "btn btn-outline-secondary" %>
  </div>

  <!-- Image Upload Modal -->
  <div class="modal fade" tabindex="-1" data-template-editor-target="imageModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Insert Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Upload option -->
          <div class="mb-3">
            <label class="form-label">Upload Image</label>
            <input type="file"
                   accept="image/*"
                   class="form-control"
                   data-template-editor-target="imageUpload"
                   data-action="change->template-editor#handleImageUpload">
            <div class="form-text">Or enter an image URL below</div>
          </div>

          <!-- URL input -->
          <div class="mb-3">
            <label class="form-label">Image URL</label>
            <input type="url"
                   class="form-control"
                   data-template-editor-target="imageUrl"
                   placeholder="https://example.com/image.jpg">
          </div>

          <!-- Upload status -->
          <div class="upload-status d-none"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" data-action="click->template-editor#insertImage">Insert Image</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<style>
.CodeMirror {
  border: 1px solid #dee2e6;
  font-size: 14px;
  height: 600px;
}

.CodeMirror-scroll {
  min-height: 600px;
}
</style>
