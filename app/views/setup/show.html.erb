<div class="container-fluid py-5" style="max-width: 800px;">
  <div class="text-center mb-5">
    <h1 class="fs-1 mb-2">Welcome to Fuegomail</h1>
    <p class="text-muted">Let's get your account set up in just a few steps</p>
  </div>

  <!-- Progress Steps -->
  <div class="d-flex justify-content-center mb-5">
    <div class="d-flex align-items-center">
      <div class="text-center">
        <div class="rounded-circle d-inline-flex align-items-center justify-content-center <%= @step >= 1 ? 'bg-primary text-white' : 'bg-light text-muted' %>" style="width: 40px; height: 40px;">
          <%= @step > 1 ? '✓' : '1' %>
        </div>
        <div class="small mt-2">Account</div>
      </div>
      <div class="border-top mx-3" style="width: 80px;"></div>
      <div class="text-center">
        <div class="rounded-circle d-inline-flex align-items-center justify-content-center <%= @step >= 2 ? 'bg-primary text-white' : 'bg-light text-muted' %>" style="width: 40px; height: 40px;">
          <%= @step > 2 ? '✓' : '2' %>
        </div>
        <div class="small mt-2">AWS SES</div>
      </div>
      <div class="border-top mx-3" style="width: 80px;"></div>
      <div class="text-center">
        <div class="rounded-circle d-inline-flex align-items-center justify-content-center <%= @step >= 3 ? 'bg-primary text-white' : 'bg-light text-muted' %>" style="width: 40px; height: 40px;">
          3
        </div>
        <div class="small mt-2">Logo</div>
      </div>
    </div>
  </div>

  <!-- Form Card -->
  <div class="card border">
    <div class="card-body p-5">
      <% if @account.errors.any? %>
        <div class="alert alert-danger mb-4" role="alert">
          <strong><%= pluralize(@account.errors.count, "error") %> prevented this from being saved:</strong>
          <ul class="mb-0 mt-2">
            <% @account.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Step 1: Account Details -->
      <% if @step == 1 %>
        <h3 class="mb-4">Step 1: Account Details</h3>

        <%= form_with(model: @account, url: setup_account_details_path, method: :post, local: true) do |f| %>
          <div class="mb-4">
            <%= f.label :name, "Account Name *", class: "form-label" %>
            <%= f.text_field :name, class: "form-control form-control-lg", placeholder: "e.g., Acme Corporation", required: true, autofocus: true %>
            <div class="form-text">This is your organization's name</div>
          </div>

          <div class="mb-4">
            <%= f.label :subdomain, "Subdomain *", class: "form-label" %>
            <div class="input-group input-group-lg">
              <%= f.text_field :subdomain, class: "form-control", placeholder: "acme", required: true, pattern: "[a-z0-9-]+", title: "Only lowercase letters, numbers, and hyphens" %>
              <span class="input-group-text">.fuegomail.com</span>
            </div>
            <div class="form-text">Used for tracking links and subscription forms (lowercase only)</div>
          </div>

          <div class="d-flex justify-content-end">
            <%= f.submit "Continue to AWS SES Setup →", class: "btn btn-primary btn-lg" %>
          </div>
        <% end %>
      <% end %>

      <!-- Step 2: AWS SES Configuration -->
      <% if @step == 2 %>
        <h3 class="mb-4">Step 2: AWS SES Configuration</h3>

        <%= form_with(model: @account, url: setup_aws_credentials_path, method: :post, local: true) do |f| %>
          <div class="alert alert-info mb-4">
            <strong>Why AWS SES?</strong> Fuegomail uses Amazon SES to send emails. You'll need an AWS account with SES access.
            <a href="https://docs.aws.amazon.com/ses/latest/dg/setting-up.html" target="_blank" class="alert-link">Learn more →</a>
          </div>

          <div class="mb-4">
            <%= f.label :aws_region, "AWS Region *", class: "form-label" %>
            <%= f.select :aws_region,
                [
                  ['US East (N. Virginia)', 'us-east-1'],
                  ['US East (Ohio)', 'us-east-2'],
                  ['US West (Oregon)', 'us-west-2'],
                  ['EU (Ireland)', 'eu-west-1'],
                  ['EU (Frankfurt)', 'eu-central-1'],
                  ['Asia Pacific (Mumbai)', 'ap-south-1'],
                  ['Asia Pacific (Sydney)', 'ap-southeast-2']
                ],
                { selected: @account.aws_region || 'us-east-1' },
                class: "form-select form-select-lg", required: true
            %>
          </div>

          <div class="mb-4">
            <%= f.label :aws_access_key_id, "AWS Access Key ID *", class: "form-label" %>
            <%= f.text_field :aws_access_key_id, class: "form-control form-control-lg", placeholder: "AKIAIOSFODNN7EXAMPLE", required: true %>
            <div class="form-text">Your AWS IAM user access key</div>
          </div>

          <div class="mb-4">
            <%= f.label :aws_secret_access_key, "AWS Secret Access Key *", class: "form-label" %>
            <%= f.password_field :aws_secret_access_key, class: "form-control form-control-lg", placeholder: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY", required: true %>
            <div class="form-text">Your AWS IAM user secret key (encrypted at rest)</div>
          </div>

          <div class="card bg-light border-0 mb-4">
            <div class="card-body">
              <h6 class="card-title mb-3">Required IAM Permissions</h6>
              <p class="small text-muted mb-3">Your IAM user needs the following permissions for Fuegomail to work properly:</p>
              <div class="small">
                <strong>Minimum Required:</strong>
                <ul class="mb-3">
                  <li><code>ses:SendEmail</code> - Send emails</li>
                  <li><code>ses:SendRawEmail</code> - Send emails with attachments</li>
                  <li><code>ses:GetSendQuota</code> - Check sending limits</li>
                  <li><code>ses:GetSendStatistics</code> - View sending stats</li>
                </ul>
                <strong>Recommended for Production:</strong>
                <ul class="mb-0">
                  <li><code>ses:VerifyEmailIdentity</code> - Verify sender addresses</li>
                  <li><code>ses:ListVerifiedEmailAddresses</code> - List verified addresses</li>
                  <li><code>ses:SetIdentityNotificationTopic</code> - Configure SNS topics for bounces/complaints</li>
                </ul>
              </div>
              <div class="mt-3">
                <details class="small">
                  <summary class="text-primary" style="cursor: pointer;">Show example IAM policy JSON</summary>
                  <pre class="mt-2 p-3 bg-white border rounded" style="font-size: 11px; overflow-x: auto;"><code>{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ses:SendEmail",
        "ses:SendRawEmail",
        "ses:GetSendQuota",
        "ses:GetSendStatistics",
        "ses:VerifyEmailIdentity",
        "ses:ListVerifiedEmailAddresses",
        "ses:SetIdentityNotificationTopic"
      ],
      "Resource": "*"
    }
  ]
}</code></pre>
                </details>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <%= f.submit "Verify & Continue →", class: "btn btn-primary btn-lg", data: { disable_with: "Verifying..." } %>
          </div>
        <% end %>
      <% end %>

      <!-- Step 3: Logo Upload -->
      <% if @step == 3 %>
        <h3 class="mb-4">Step 3: Upload Your Logo (Optional)</h3>

        <%= form_with(model: @account, url: setup_logo_path, method: :post, local: true) do |f| %>
          <div class="alert alert-info mb-4">
            <strong>Optional but recommended!</strong> Your logo will appear in email templates. You can always add or change it later.
          </div>

          <div class="mb-4">
            <%= f.label :logo, "Company Logo", class: "form-label" %>
            <%= f.file_field :logo, accept: "image/*", class: "form-control form-control-lg" %>
            <div class="form-text">PNG, JPG, or GIF. Recommended size: 200x80px</div>
          </div>

          <% if @account.logo.attached? %>
            <div class="mb-4">
              <label class="form-label">Current Logo</label>
              <div class="border p-3 bg-light">
                <%= image_tag @account.logo_url, style: "max-width: 200px; max-height: 80px;" %>
              </div>
            </div>
          <% end %>

          <div class="d-flex justify-content-end gap-2">
            <%= button_to "Skip for now", setup_skip_logo_path, method: :post, class: "btn btn-outline-secondary btn-lg" %>
            <%= f.submit "Complete Setup", class: "btn btn-success btn-lg" %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="text-center mt-4">
    <small class="text-muted">Need help? Check out our <a href="#">documentation</a></small>
  </div>
</div>

<style>
.form-control-lg, .form-select-lg {
  font-size: 1.1rem;
}
</style>
