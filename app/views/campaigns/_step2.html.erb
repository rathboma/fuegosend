<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>

<h5 class="mb-3">Email Content</h5>

<div class="alert alert-info small mb-3">
  <strong>Template:</strong> <%= @templates.find_by(id: campaign.template_id)&.name || "No template selected" %>
  <% if @step == 2 %>
    <%= link_to "â† Change template", campaign.persisted? ? edit_campaign_path(campaign, step: 1) : new_campaign_path(step: 1), class: "ms-2" %>
  <% end %>
</div>

<div class="row g-4"
     data-controller="markdown-editor"
     data-markdown-editor-preview-url-value="<%= preview_campaign_path(campaign) %>"
     data-markdown-editor-save-url-value="<%= campaign.persisted? ? campaign_path(campaign) : '' %>"
     data-markdown-editor-upload-url-value="<%= images_path %>"
     data-markdown-editor-csrf-token-value="<%= form_authenticity_token %>">
  <!-- Markdown Editor (Left) -->
  <div class="col-md-6">
    <div class="mb-2 d-flex justify-content-between align-items-center">
      <div>
        <strong>Markdown Content</strong>
        <small class="text-muted ms-2">Your email content</small>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="btn-toolbar mb-2 p-2 bg-light border rounded" role="toolbar">
      <div class="btn-group btn-group-sm me-2" role="group">
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#bold" title="Bold">
          <strong>B</strong>
        </button>
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#italic" title="Italic">
          <em>I</em>
        </button>
      </div>
      <div class="btn-group btn-group-sm me-2" role="group">
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#heading1" title="Heading 1">
          H1
        </button>
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#heading2" title="Heading 2">
          H2
        </button>
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#heading3" title="Heading 3">
          H3
        </button>
      </div>
      <div class="btn-group btn-group-sm me-2" role="group">
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#link" title="Insert Link">
          ðŸ”—
        </button>
        <button type="button" class="btn btn-outline-secondary" data-action="click->markdown-editor#triggerImageUpload" title="Upload Image">
          ðŸ“·
        </button>
      </div>
    </div>

    <!-- Hidden file input for image uploads -->
    <input type="file"
           accept="image/*"
           data-markdown-editor-target="imageUpload"
           data-action="change->markdown-editor#handleImageUpload"
           style="display: none;">

    <div class="card border">
      <div class="card-body p-0">
        <%= f.text_area :body_markdown, class: "d-none", data: { markdown_editor_target: "hiddenField" } %>
        <textarea data-markdown-editor-target="textarea" style="display: none;"><%= campaign.body_markdown %></textarea>
      </div>
    </div>
    <div class="mt-2">
      <small class="text-muted">
        <strong>Merge Tags:</strong>
        <code>{{email}}</code>,
        <code>{{name}}</code>,
        <code>{{custom_first_name}}</code>,
        <code>{{custom_company}}</code>,
        <code>{{logo_url}}</code>,
        <code>{{unsubscribe_url}}</code>
      </small>
    </div>
  </div>

  <!-- Preview (Right) -->
  <div class="col-md-6">
    <div class="mb-2">
      <strong>Preview</strong>
      <small class="text-muted ms-2">How it will look to subscribers</small>
    </div>
    <div class="card border">
      <div class="card-body p-0">
        <iframe
          data-markdown-editor-target="preview"
          style="width: 100%; height: 600px; border: none; display: block;"
          sandbox="allow-same-origin"
          title="Email Preview">
        </iframe>
      </div>
    </div>
    <div class="mt-2">
      <small class="text-muted">
        Preview updates automatically as you type
        <span class="text-success d-none" data-markdown-editor-target="saveStatus">âœ“ Saved</span>
      </small>
    </div>
  </div>
</div>

<%= f.hidden_field :step, value: 2 %>

<div class="d-flex gap-2 mt-4">
  <%= link_to "â† Back to Details", campaign.persisted? ? edit_campaign_path(campaign, step: 1) : new_campaign_path(step: 1), class: "btn btn-outline-secondary" %>
  <%= f.submit "Continue to Review â†’", class: "btn btn-primary" %>
</div>

<style>
.CodeMirror {
  border: 1px solid #dee2e6;
  font-size: 14px;
  height: 600px;
}

.CodeMirror-scroll {
  min-height: 600px;
}
</style>
