<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>

<h5 class="mb-3">Email Content</h5>

<div class="alert alert-info small mb-3">
  <strong>Template:</strong> <%= @templates.find_by(id: campaign.template_id)&.name || "No template selected" %>
  <% if @step == 2 %>
    <%= link_to "← Change template", campaign.persisted? ? edit_campaign_path(campaign, step: 1) : new_campaign_path(step: 1), class: "ms-2" %>
  <% end %>
</div>

<div class="row g-4"
     data-controller="markdown-editor"
     data-markdown-editor-preview-url-value="<%= preview_campaign_path(campaign) %>">
  <!-- Markdown Editor (Left) -->
  <div class="col-md-6">
    <div class="mb-2">
      <strong>Markdown Content</strong>
      <small class="text-muted ms-2">Your email content</small>
    </div>
    <div class="card border">
      <div class="card-body p-0">
        <%= f.text_area :body_markdown, class: "d-none", data: { markdown_editor_target: "hiddenField" } %>
        <textarea data-markdown-editor-target="textarea" style="display: none;"><%= campaign.body_markdown %></textarea>
      </div>
    </div>
    <div class="mt-2">
      <small class="text-muted">
        <strong>Merge Tags:</strong>
        <code>{{email}}</code>,
        <code>{{name}}</code>,
        <code>{{custom_first_name}}</code>,
        <code>{{custom_company}}</code>,
        <code>{{logo_url}}</code>,
        <code>{{unsubscribe_url}}</code>
      </small>
    </div>
  </div>

  <!-- Preview (Right) -->
  <div class="col-md-6">
    <div class="mb-2">
      <strong>Preview</strong>
      <small class="text-muted ms-2">How it will look to subscribers</small>
    </div>
    <div class="card border">
      <div class="card-body p-0">
        <iframe
          data-markdown-editor-target="preview"
          style="width: 100%; height: 600px; border: none; display: block;"
          sandbox="allow-same-origin"
          title="Email Preview">
        </iframe>
      </div>
    </div>
    <div class="mt-2">
      <small class="text-muted">Preview updates automatically as you type (debounced 500ms)</small>
    </div>
  </div>
</div>

<%= f.hidden_field :step, value: 2 %>

<div class="d-flex gap-2 mt-4">
  <%= link_to "← Back to Details", campaign.persisted? ? edit_campaign_path(campaign, step: 1) : new_campaign_path(step: 1), class: "btn btn-outline-secondary" %>
  <%= f.submit "Continue to Review →", class: "btn btn-primary" %>
</div>

<style>
.CodeMirror {
  border: 1px solid #dee2e6;
  font-size: 14px;
  height: 600px;
}

.CodeMirror-scroll {
  min-height: 600px;
}
</style>
